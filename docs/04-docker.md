# Docker

> Справочник-примечание к Шагу 5

**⏱ Время: ~20 минут**

На твоём компьютере сайт работает. Ты запускаешь
`npm run dev`, открываешь браузер -- всё отлично. Но
есть проблема: на сервере другая операционная система,
другие версии программ, другие настройки. То, что
работает у тебя, может не заработать там.

Docker решает это. Он упаковывает твой сайт вместе
со всем необходимым (Node.js нужной версии, все
библиотеки, все настройки) в специальный «контейнер».
Этот контейнер работает одинаково везде: на твоём
компьютере, на сервере, на компьютере друга.

---

## Часть 1: Что такое Docker

**Docker -- это чемодан для переезда.** Представь, что
ты переезжаешь в новую квартиру. Можно перевозить вещи
россыпью -- что-то потеряется, что-то сломается,
что-то забудешь. А можно аккуратно сложить всё
в чемодан: одежду, документы, зарядки. Приезжаешь
на новое место, открываешь чемодан -- всё на месте.

Docker делает то же самое с твоим сайтом. Складывает
код, настройки и зависимости в «контейнер» -- и этот
контейнер можно запустить на любом компьютере.

### Три ключевых понятия

#### Образ (Image)

**Образ -- это рецепт.** Файл с инструкциями, который
описывает, что положить в чемодан: какую версию
Node.js взять, какие файлы скопировать, какие команды
выполнить. Этот рецепт записывается в специальный файл
`Dockerfile`.

Образ создаётся один раз. Потом из него можно
запускать сколько угодно контейнеров.

#### Контейнер (Container)

**Контейнер -- это чемодан в действии.** Когда ты
«запускаешь» образ, он превращается в контейнер --
работающую копию твоего сайта со всем необходимым
внутри.

Контейнер изолирован от основной системы. Он не видит
файлы на твоём компьютере (кроме тех, которые ты
явно ему покажешь), и твой компьютер не видит, что
внутри контейнера. Это как отдельный маленький
компьютер внутри твоего компьютера.

#### Docker Compose

**Docker Compose -- это инструкция для запуска.**
Если Dockerfile описывает *что* положить в чемодан,
то Docker Compose описывает *как* этот чемодан
использовать: на каком порту запустить сайт, нужно ли
перезапускать его при ошибках, какие переменные
окружения передать.

Записывается в файл `docker-compose.yml`.

> TODO: добавить ссылку
>
> Что такое Docker -- видео

---

## Часть 2: Установка Docker Desktop

**⏱ ~10 минут**

### Проверка

Может, Docker уже установлен? Проверь -- открой
терминал (в VS Code: **Ctrl+`**) и набери:

```bash
docker --version
```

Если увидишь что-то вроде `Docker version 27.x.x` --
Docker уже есть, переходи к Части 3.

Если команда не найдена -- нужно установить.

### Установка

1. Открой в браузере
   [docker.com/products/docker-desktop](https://www.docker.com/products/docker-desktop/)
2. Нажми **"Download for Windows"**
3. Дождись скачивания (файл ~500 МБ, может занять
   несколько минут)
4. Открой скачанный файл двойным кликом
5. Появится окно установки. Если спросит про WSL2 --
   оставь галочку включённой (об этом ниже)
6. Нажми **"Ok"** и дождись окончания установки
7. **Перезагрузи компьютер** (это важно!)
8. После перезагрузки найди **Docker Desktop** в меню
   "Пуск" и запусти его
9. Подожди пока Docker загрузится -- иконка кита
   в трее (правый нижний угол экрана) должна
   перестать мигать и стать стабильной
10. Проверь в терминале:

```bash
docker --version
```

Если видишь версию -- всё готово!

<!-- screenshot: Docker Desktop -->

> **⚠️ Docker Desktop требует WSL2**
>
> WSL2 (Windows Subsystem for Linux) -- это
> встроенная в Windows возможность запускать
> Linux-программы. Docker использует её для работы.
> Обычно установщик Docker сам предлагает поставить
> WSL2. Если спрашивает -- соглашайся. Если возникли
> проблемы с WSL2 -- попроси Claude помочь,
> он проведёт через установку пошагово.

> **⚠️ Docker Desktop «тяжёлый»**
>
> Docker Desktop может занимать 2-4 ГБ оперативной
> памяти. Это нормально -- он запускает маленькую
> виртуальную машину Linux внутри Windows. Если
> компьютер начинает тормозить, можно закрыть Docker
> Desktop когда он не нужен (правый клик на иконку
> кита в трее → Quit Docker Desktop).

---

## Часть 3: Dockerfile

**⏱ ~5 минут**

Dockerfile -- это рецепт для сборки контейнера. Как
кулинарный рецепт: «сначала возьми это, потом сделай
то, потом подавай на стол». Только вместо продуктов --
код, а вместо духовки -- сборщик Docker.

### Создание файла

Создай файл `Dockerfile` (без расширения!) в корне
своего проекта (папка `my-site/`):

```dockerfile
# Этап 1: Установка зависимостей
# Берём Node.js 20 (лёгкая версия на базе Alpine Linux)
FROM node:20-alpine AS deps

# Устанавливаем рабочую папку внутри контейнера
WORKDIR /app

# Копируем файлы со списком зависимостей
COPY package.json package-lock.json ./

# Устанавливаем зависимости (ci = чистая установка)
RUN npm ci


# Этап 2: Сборка сайта
FROM node:20-alpine AS builder
WORKDIR /app

# Берём зависимости из предыдущего этапа
COPY --from=deps /app/node_modules ./node_modules

# Копируем весь исходный код
COPY . .

# Собираем продакшн-версию сайта
RUN npm run build


# Этап 3: Запуск
FROM node:20-alpine AS runner
WORKDIR /app

# Указываем что это продакшн
ENV NODE_ENV=production

# Копируем только то, что нужно для работы
# (не весь исходный код, а только собранный сайт)
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

# Открываем порт 3000
EXPOSE 3000

# Запускаем сервер
CMD ["node", "server.js"]
```

### Что тут происходит

Этот Dockerfile использует **multi-stage build** --
сборку в несколько этапов. Звучит сложно, но идея
простая:

1. **Этап 1 (deps)** -- устанавливаем библиотеки.
   Как сходить в магазин за продуктами.
2. **Этап 2 (builder)** -- собираем сайт. Как
   приготовить блюдо из этих продуктов.
3. **Этап 3 (runner)** -- оставляем только готовое
   блюдо. Грязная посуда и обрезки (исходный код,
   dev-зависимости) остаются за бортом.

Зачем так? Чтобы итоговый контейнер был маленьким.
В нём только то, что нужно для работы сайта --
ничего лишнего.

### Настройка Next.js для Docker

Чтобы третий этап работал, нужно сказать Next.js
создавать standalone-версию при сборке. Открой файл
`next.config.ts` (или `next.config.mjs`) в корне
проекта и добавь настройку `output: 'standalone'`:

```typescript
// next.config.ts
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  output: 'standalone',  // <-- добавь эту строку
};

export default nextConfig;
```

`standalone` говорит Next.js: «при сборке создай
версию, которая может работать сама по себе, без
`node_modules`». Именно эту версию мы копируем
в контейнер на третьем этапе.

> **⚠️ Если у тебя уже есть настройки в next.config**
>
> Не заменяй файл целиком! Просто добавь строку
> `output: 'standalone'` к существующим настройкам.
> Если не уверен -- попроси Claude помочь.

---

## Часть 4: docker-compose.yml

**⏱ ~3 минуты**

Docker Compose -- это файл, который говорит Docker
*как* запускать контейнер. Без него пришлось бы
каждый раз набирать длинную команду с кучей
параметров. А так -- один файл, одна команда.

### Создание файла

Создай файл `docker-compose.yml` в корне проекта
(папка `my-site/`, рядом с `Dockerfile`):

```yaml
# Описание сервисов (контейнеров)
services:
  # Наш веб-сервер
  web:
    # Собрать образ из Dockerfile в текущей папке
    build: .
    # Связать порт 3000 контейнера с портом 3000 компьютера
    ports:
      - "3000:3000"
    # Перезапускать автоматически, если контейнер упадёт
    # (кроме случаев, когда ты сам его остановил)
    restart: unless-stopped
```

### Что значит каждая строка

- **`services:`** -- раздел, где перечислены все
  контейнеры. У нас он один -- `web`.
- **`web:`** -- название контейнера. Можно назвать
  как угодно, `web` -- просто понятное имя.
- **`build: .`** -- «собери образ из Dockerfile,
  который лежит в текущей папке (`.`)».
- **`ports: - "3000:3000"`** -- «когда я открою
  `localhost:3000` на своём компьютере, направь
  запрос на порт 3000 внутри контейнера». Формат:
  `порт_компьютера:порт_контейнера`.
- **`restart: unless-stopped`** -- «если контейнер
  упадёт (ошибка, нехватка памяти) -- перезапусти
  его автоматически. Но если я сам его остановил --
  не перезапускай».

---

## Часть 5: Запуск

**⏱ ~5 минут**

Всё готово! Давай запустим сайт в Docker.

### Сборка и запуск

Открой терминал в VS Code (**Ctrl+`**), убедись
что ты в папке проекта (`my-site/`), и выполни:

```bash
# Собрать образ и запустить контейнер
docker compose up --build
```

**Подожди.** Первая сборка может занять несколько
минут -- Docker скачивает базовый образ Node.js,
устанавливает зависимости, собирает сайт. В терминале
будут бежать строки с логами -- это нормально.

Когда увидишь что-то вроде:

```
web-1  | ▲ Next.js 15.x.x
web-1  | - Local: http://localhost:3000
web-1  |
web-1  | ✓ Ready in XXms
```

-- сайт запущен!

<!-- screenshot: docker compose up в терминале -->

### Проверка

Открой в браузере: **http://localhost:3000**

Ты должен увидеть свой сайт -- тот же самый, что
работал через `npm run dev`. Только теперь он
работает внутри Docker-контейнера!

<!-- screenshot: сайт через Docker -->

### Остановка

Чтобы остановить контейнер, нажми **Ctrl+C**
в терминале, где он запущен. Или выполни в другом
терминале:

```bash
# Остановить контейнер
docker compose down
```

### Повторный запуск

В следующий раз, если ты не менял код, можно
запустить без `--build`:

```bash
# Запустить без пересборки
docker compose up
```

Если менял код -- добавь `--build`, чтобы Docker
пересобрал образ с новыми изменениями:

```bash
# Пересобрать и запустить
docker compose up --build
```

> **⚠️ Если сборка завершилась ошибкой**
>
> Частые причины:
>
> - **"Cannot find module"** или ошибки импорта --
>   проверь что `npm run build` работает локально
>   (без Docker). Если локальная сборка тоже падает --
>   сначала исправь ошибки в коде.
> - **"COPY failed: file not found"** -- проверь что
>   Dockerfile лежит в корне проекта, рядом
>   с `package.json`.
> - **Ошибки с правами доступа** -- попробуй
>   запустить терминал от имени администратора.
> - **Docker Desktop не запущен** -- убедись что
>   Docker Desktop работает (иконка кита в трее).
>
> Если ничего не помогает -- скопируй текст ошибки
> и покажи Claude. Он разберётся.

---

## Навигация

- ← Назад: [Git и GitHub](03-git.md)
- → Далее: [Домен, VPS и деплой](05-deploy.md)
